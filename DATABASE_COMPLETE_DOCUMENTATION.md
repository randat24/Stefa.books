# ÐŸÐžÐ›ÐÐÐ¯ Ð”ÐžÐšÐ£ÐœÐ•ÐÐ¢ÐÐ¦Ð˜Ð¯ Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥ STEFA.BOOKS

## ðŸ“‹ Ð¡Ð¾Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ

1. [ÐžÐ±Ð·Ð¾Ñ€ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹](#Ð¾Ð±Ð·Ð¾Ñ€-Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹)
2. [Ð¡Ñ…ÐµÐ¼Ñ‹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†](#ÑÑ…ÐµÐ¼Ñ‹-Ñ‚Ð°Ð±Ð»Ð¸Ñ†)
3. [Ð¡Ð²ÑÐ·Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼Ð¸](#ÑÐ²ÑÐ·Ð¸-Ð¼ÐµÐ¶Ð´Ñƒ-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼Ð¸)
4. [Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñ‹](#Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸-Ð¸-Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñ‹)
5. [RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸](#rls-Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸-Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸)
6. [ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸](#Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ-Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸)
7. [Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ](#Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸-Ð¿Ð¾-Ñ€Ð°Ð±Ð¾Ñ‚Ðµ)
8. [Ð§ÐµÐº-Ð»Ð¸ÑÑ‚Ñ‹](#Ñ‡ÐµÐº-Ð»Ð¸ÑÑ‚Ñ‹)
9. [Troubleshooting](#troubleshooting)

---

## ðŸ—ï¸ ÐžÐ±Ð·Ð¾Ñ€ Ð°Ñ€Ñ…Ð¸Ñ‚ÐµÐºÑ‚ÑƒÑ€Ñ‹

### Ð¢ÐµÑ…Ð½Ð¾Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÑ‚ÐµÐº
- **Ð‘Ð°Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…**: PostgreSQL (Supabase)
- **ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ**: Supabase Auth
- **Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ**: Row Level Security (RLS)
- **Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²**: Cloudinary
- **Ð”ÐµÐ¿Ð»Ð¾Ð¹**: Vercel

### ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÑÑƒÑ‰Ð½Ð¾ÑÑ‚Ð¸
- **ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸** (`users`, `profiles`)
- **ÐšÐ½Ð¸Ð³Ð¸** (`books`, `authors`, `book_authors`)
- **ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸** (`main_categories`, `subcategories`)
- **ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ¸** (`subscriptions`, `plans`)
- **ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð¸** (`payments`)
- **Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ** (`notification_queue`)

---

## ðŸ“Š Ð¡Ñ…ÐµÐ¼Ñ‹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†

### 1. ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¸ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ð¸

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `users`
```sql
CREATE TABLE public.users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text UNIQUE NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  is_admin boolean DEFAULT false
);
```

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `profiles`
```sql
CREATE TABLE public.profiles (
  id uuid PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  first_name text,
  last_name text,
  phone text,
  subscription_id uuid REFERENCES public.subscriptions(id),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### 2. ÐšÐ½Ð¸Ð³Ð¸ Ð¸ Ð°Ð²Ñ‚Ð¾Ñ€Ñ‹

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `books`
```sql
CREATE TABLE public.books (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  title text NOT NULL,
  description text,
  cover_url text,
  pages int,
  category text,
  subcategory_id uuid REFERENCES public.main_categories(id),
  tsvector tsvector,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `authors`
```sql
CREATE TABLE public.authors (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  biography text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `book_authors` (ÑÐ²ÑÐ·ÑŒ Ð¼Ð½Ð¾Ð³Ð¸Ðµ-ÐºÐ¾-Ð¼Ð½Ð¾Ð³Ð¸Ð¼)
```sql
CREATE TABLE public.book_authors (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  book_id uuid REFERENCES public.books(id) ON DELETE CASCADE,
  author_id uuid REFERENCES public.authors(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now(),
  UNIQUE(book_id, author_id)
);
```

### 3. ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `main_categories`
```sql
CREATE TABLE public.main_categories (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  icon text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `subcategories`
```sql
CREATE TABLE public.subcategories (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  main_category_id uuid REFERENCES public.main_categories(id) ON DELETE CASCADE,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### 4. ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¸ Ð¿Ð»Ð°Ð½Ñ‹

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `plans`
```sql
CREATE TABLE public.plans (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  price_monthly decimal(10,2),
  price_yearly decimal(10,2),
  max_books_per_month int DEFAULT 5,
  max_books_total int DEFAULT 50,
  is_active boolean DEFAULT true,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `subscriptions`
```sql
CREATE TABLE public.subscriptions (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES public.users(id) ON DELETE CASCADE,
  plan_id uuid REFERENCES public.plans(id) ON DELETE CASCADE,
  status text DEFAULT 'active' CHECK (status IN ('active', 'cancelled', 'expired')),
  started_at timestamptz DEFAULT now(),
  expires_at timestamptz NOT NULL,
  auto_renew boolean DEFAULT true,
  books_used_this_month int DEFAULT 0,
  total_books_used int DEFAULT 0,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### 5. ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð¸

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `payments`
```sql
CREATE TABLE public.payments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES public.users(id) ON DELETE CASCADE,
  subscription_id uuid REFERENCES public.subscriptions(id) ON DELETE CASCADE,
  amount decimal(10,2) NOT NULL,
  currency text DEFAULT 'UAH',
  status text DEFAULT 'pending' CHECK (status IN ('pending', 'completed', 'failed', 'refunded')),
  payment_method text,
  transaction_id text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### 6. Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `notification_queue`
```sql
CREATE TABLE public.notification_queue (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES public.users(id) ON DELETE CASCADE,
  type text NOT NULL CHECK (type IN ('subscription_expired', 'payment_failed', 'book_available')),
  title text NOT NULL,
  message text NOT NULL,
  is_read boolean DEFAULT false,
  sent_at timestamptz,
  created_at timestamptz DEFAULT now()
);
```

### 7. Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ‡Ñ‚ÐµÐ½Ð¸Ñ

#### Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° `reading_history`
```sql
CREATE TABLE public.reading_history (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES public.users(id) ON DELETE CASCADE,
  book_id uuid REFERENCES public.books(id) ON DELETE CASCADE,
  started_at timestamptz DEFAULT now(),
  finished_at timestamptz,
  rating int CHECK (rating >= 1 AND rating <= 5),
  review text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

---

## ðŸ”— Ð¡Ð²ÑÐ·Ð¸ Ð¼ÐµÐ¶Ð´Ñƒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼Ð¸

### Ð”Ð¸Ð°Ð³Ñ€Ð°Ð¼Ð¼Ð° ÑÐ²ÑÐ·ÐµÐ¹
```
users (1) â†â†’ (1) profiles
users (1) â†â†’ (N) subscriptions
users (1) â†â†’ (N) payments
users (1) â†â†’ (N) notification_queue
users (1) â†â†’ (N) reading_history

plans (1) â†â†’ (N) subscriptions

books (N) â†â†’ (N) authors (Ñ‡ÐµÑ€ÐµÐ· book_authors)
books (N) â†â†’ (1) main_categories (Ñ‡ÐµÑ€ÐµÐ· subcategory_id)
books (1) â†â†’ (N) reading_history

main_categories (1) â†â†’ (N) subcategories
```

### ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ ÑÐ²ÑÐ·Ð¸
- **ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ â†’ ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ**: ÐžÐ´Ð¸Ð½ Ðº Ð¾Ð´Ð½Ð¾Ð¼Ñƒ
- **ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ â†’ ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ¸**: ÐžÐ´Ð¸Ð½ ÐºÐ¾ Ð¼Ð½Ð¾Ð³Ð¸Ð¼
- **ÐŸÐ»Ð°Ð½ â†’ ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ¸**: ÐžÐ´Ð¸Ð½ ÐºÐ¾ Ð¼Ð½Ð¾Ð³Ð¸Ð¼
- **ÐšÐ½Ð¸Ð³Ð° â†’ ÐÐ²Ñ‚Ð¾Ñ€Ñ‹**: ÐœÐ½Ð¾Ð³Ð¸Ðµ ÐºÐ¾ Ð¼Ð½Ð¾Ð³Ð¸Ð¼
- **ÐšÐ½Ð¸Ð³Ð° â†’ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ñ**: ÐœÐ½Ð¾Ð³Ð¸Ðµ Ðº Ð¾Ð´Ð½Ð¾Ð¼Ñƒ

---

## âš™ï¸ Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¸ Ð¿Ñ€Ð¾Ñ†ÐµÐ´ÑƒÑ€Ñ‹

### 1. Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ñ‹

#### `touch_updated_at()`
```sql
CREATE OR REPLACE FUNCTION public.touch_updated_at()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;
```

#### `books_tsvector()`
```sql
CREATE OR REPLACE FUNCTION public.books_tsvector()
RETURNS trigger
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  NEW.tsvector := to_tsvector('ukrainian', 
    COALESCE(NEW.title, '') || ' ' || 
    COALESCE(NEW.description, '')
  );
  RETURN NEW;
END;
$$;
```

### 2. Ð‘Ð¸Ð·Ð½ÐµÑ-Ð»Ð¾Ð³Ð¸ÐºÐ°

#### `check_subscription_limits(user_id, books_requested)`
```sql
CREATE OR REPLACE FUNCTION public.check_subscription_limits(
  user_id uuid,
  books_requested int DEFAULT 1
)
RETURNS TABLE (
  can_rent boolean,
  books_remaining_this_month int,
  books_remaining_total int,
  subscription_status text
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
-- ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚ Ð»Ð¸Ð¼Ð¸Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
$$;
```

#### `create_subscription(user_id, plan_uuid, duration_months)`
```sql
CREATE OR REPLACE FUNCTION public.create_subscription(
  user_id uuid,
  plan_uuid uuid,
  duration_months int DEFAULT 1
)
RETURNS uuid
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
-- Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ Ð½Ð¾Ð²ÑƒÑŽ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÑƒ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
$$;
```

### 3. ÐŸÐ¾Ð¸ÑÐº Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ

#### `search_books_by_author(author_name, limit_count)`
```sql
CREATE OR REPLACE FUNCTION public.search_books_by_author(
  author_name text, 
  limit_count int DEFAULT 20
)
RETURNS TABLE (
  book_id uuid,
  title text,
  cover_url text,
  author_names text
)
LANGUAGE sql STABLE
SET search_path = public
AS $$
-- ÐŸÐ¾Ð¸ÑÐº ÐºÐ½Ð¸Ð³ Ð¿Ð¾ Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ
$$;
```

#### `get_books_detailed(limit_count)`
```sql
CREATE OR REPLACE FUNCTION public.get_books_detailed(limit_count int DEFAULT 50)
RETURNS TABLE (
  book_id uuid,
  title text,
  description text,
  cover_url text,
  pages int,
  author_names text,
  category_name text
)
LANGUAGE sql STABLE
SET search_path = public
AS $$
-- ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ ÐºÐ½Ð¸Ð³Ð°Ñ…
$$;
```

---

## ðŸ”’ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

### ÐŸÑ€Ð¸Ð½Ñ†Ð¸Ð¿Ñ‹ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
- **Deny by default** - Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ð·Ð°Ð¿Ñ€ÐµÑ‰ÐµÐ½
- **ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ** - ÐºÐ°Ñ‚Ð°Ð»Ð¾Ð³ ÐºÐ½Ð¸Ð³ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð²ÑÐµÐ¼
- **ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ** - Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÑŒÑ†Ñƒ
- **ÐÐ´Ð¼Ð¸Ð½ÑÐºÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ** - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°Ð¼

### ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†
```sql
-- ÐšÐ½Ð¸Ð³Ð¸ - Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿
CREATE POLICY "ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ½Ð¸Ð³Ð°Ð¼" ON public.books
  FOR SELECT USING (true);

-- ÐÐ²Ñ‚Ð¾Ñ€Ñ‹ - Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿
CREATE POLICY "ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð¼" ON public.authors
  FOR SELECT USING (true);

-- ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ - Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿
CREATE POLICY "ÐŸÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÐ¼" ON public.main_categories
  FOR SELECT USING (true);
```

### ÐŸÐ¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†
```sql
-- ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ
CREATE POLICY "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ" ON public.users
  FOR ALL USING (auth.uid()::text = id::text);

-- ÐŸÐ»Ð°Ñ‚ÐµÐ¶Ð¸ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸
CREATE POLICY "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸" ON public.payments
  FOR ALL USING (auth.uid()::text = user_id::text);

-- Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
CREATE POLICY "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ" ON public.notification_queue
  FOR ALL USING (auth.uid()::text = user_id::text);
```

---

## âš¡ ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

### ÐšÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ðµ Ð¸Ð½Ð´ÐµÐºÑÑ‹

#### Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… ÐºÐ»ÑŽÑ‡ÐµÐ¹
```sql
-- Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… ÑÐ²ÑÐ·ÐµÐ¹
CREATE INDEX IF NOT EXISTS idx_books_subcategory_id ON public.books (subcategory_id);
CREATE INDEX IF NOT EXISTS idx_notification_queue_user_id ON public.notification_queue (user_id);
CREATE INDEX IF NOT EXISTS idx_book_authors_book_id ON public.book_authors (book_id);
CREATE INDEX IF NOT EXISTS idx_book_authors_author_id ON public.book_authors (author_id);
CREATE INDEX IF NOT EXISTS idx_subcategories_main_category_id ON public.subcategories (main_category_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_user_id ON public.subscriptions (user_id);
CREATE INDEX IF NOT EXISTS idx_subscriptions_plan_id ON public.subscriptions (plan_id);
CREATE INDEX IF NOT EXISTS idx_payments_user_id ON public.payments (user_id);
CREATE INDEX IF NOT EXISTS idx_reading_history_user_id ON public.reading_history (user_id);
CREATE INDEX IF NOT EXISTS idx_reading_history_book_id ON public.reading_history (book_id);
```

#### Ð˜Ð½Ð´ÐµÐºÑÑ‹ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¸ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸
```sql
-- ÐŸÐ¾Ð»Ð½Ð¾Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº
CREATE INDEX IF NOT EXISTS idx_books_title_gin ON public.books USING gin (to_tsvector('ukrainian', title));
CREATE INDEX IF NOT EXISTS idx_books_description_gin ON public.books USING gin (to_tsvector('ukrainian', description));

-- Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð¾ Ð´Ð°Ñ‚Ð°Ð¼
CREATE INDEX IF NOT EXISTS idx_books_created_at ON public.books (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_users_created_at ON public.users (created_at DESC);
CREATE INDEX IF NOT EXISTS idx_subscriptions_expires_at ON public.subscriptions (expires_at);

-- Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼
CREATE INDEX IF NOT EXISTS idx_subscriptions_status ON public.subscriptions (status);
CREATE INDEX IF NOT EXISTS idx_payments_status ON public.payments (status);
CREATE INDEX IF NOT EXISTS idx_notification_queue_is_read ON public.notification_queue (is_read);
```

#### Ð¡Ð¾ÑÑ‚Ð°Ð²Ð½Ñ‹Ðµ Ð¸Ð½Ð´ÐµÐºÑÑ‹
```sql
-- Ð”Ð»Ñ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
CREATE INDEX IF NOT EXISTS idx_subscriptions_user_status ON public.subscriptions (user_id, status);
CREATE INDEX IF NOT EXISTS idx_payments_user_status ON public.payments (user_id, status);
CREATE INDEX IF NOT EXISTS idx_reading_history_user_finished ON public.reading_history (user_id, finished_at);
```

### ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº

#### Ð­Ñ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
```sql
-- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ payments
CREATE POLICY "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð¸" ON public.payments
  FOR ALL USING ((SELECT auth.uid())::text = user_id::text);

-- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ notification_queue
CREATE POLICY "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ" ON public.notification_queue
  FOR ALL USING ((SELECT auth.uid())::text = user_id::text);

-- ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð´Ð»Ñ reading_history
CREATE POLICY "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð²Ð¸Ð´ÑÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ²Ð¾ÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ" ON public.reading_history
  FOR ALL USING ((SELECT auth.uid())::text = user_id::text);
```

### ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

#### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
```sql
-- Ð¢Ð¾Ð¿ Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
SELECT 
  query,
  calls,
  total_time,
  mean_time,
  rows,
  shared_blks_hit,
  shared_blks_read
FROM pg_stat_statements
ORDER BY mean_time DESC
LIMIT 10;
```

#### ÐÐ½Ð°Ð»Ð¸Ð· Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²
```sql
-- ÐÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¸Ð½Ð´ÐµÐºÑÑ‹
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0
ORDER BY schemaname, tablename;
```

#### Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ‚Ð°Ð±Ð»Ð¸Ñ†
```sql
-- Ð Ð°Ð·Ð¼ÐµÑ€ Ñ‚Ð°Ð±Ð»Ð¸Ñ† Ð¸ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²
SELECT 
  schemaname,
  tablename,
  pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as total_size,
  pg_size_pretty(pg_relation_size(schemaname||'.'||tablename)) as table_size,
  pg_size_pretty(pg_indexes_size(schemaname||'.'||tablename)) as index_size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

### ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ

#### Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ð¸
```bash
# Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð²ÑÐµÑ… Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
./run_complete_performance_fixes.sh
```

#### Ð‘ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
```bash
# Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ð½Ñ‹Ðµ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
psql "$SUPABASE_URL" -f PERFORMANCE_FIXES_SAFE.sql
```

#### Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ RLS Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼
```bash
# ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº
psql "$SUPABASE_URL" -f FIX_RLS_PERFORMANCE_SAFE.sql
```

### Ð ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

#### 1. Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ð¾Ðµ Ð¾Ð±ÑÐ»ÑƒÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ
- **Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¾**: ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ (`ANALYZE`)
- **Ð•Ð¶ÐµÐ¼ÐµÑÑÑ‡Ð½Ð¾**: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²
- **ÐŸÐ¾ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ÑÑ‚Ð¸**: ÐŸÐµÑ€ÐµÐ¸Ð½Ð´ÐµÐºÑÐ°Ñ†Ð¸Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†

#### 2. ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… Ð¼ÐµÑ‚Ñ€Ð¸Ðº
- Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²
- Ð Ð°Ð·Ð¼ÐµÑ€ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹

#### 3. ÐžÐ¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ EXPLAIN ANALYZE Ð´Ð»Ñ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
- Ð˜Ð·Ð±ÐµÐ³Ð°Ð½Ð¸Ðµ SELECT * Ð² Ð¿Ñ€Ð¾Ð´Ð°ÐºÑˆÐµÐ½Ðµ
- ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ JOIN
- ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‡Ð°ÑÑ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…

---

## ðŸ“‹ Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ

### 1. Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ½Ð¸Ð³Ð¸

#### Ð¨Ð°Ð³ 1: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð² (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
```sql
INSERT INTO public.authors (name, biography)
VALUES ('Ð˜Ð¼Ñ ÐÐ²Ñ‚Ð¾Ñ€Ð°', 'Ð‘Ð¸Ð¾Ð³Ñ€Ð°Ñ„Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð°');
```

#### Ð¨Ð°Ð³ 2: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð¸
```sql
INSERT INTO public.books (title, description, cover_url, pages, category, subcategory_id)
VALUES (
  'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð¸',
  'ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð¸',
  'https://res.cloudinary.com/your-cloud/image/upload/v1234567890/book-cover.jpg',
  200,
  'Ð”ÐµÑ‚ÑÐºÐ°Ñ Ð»Ð¸Ñ‚ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð°',
  (SELECT id FROM public.main_categories WHERE name = 'Ð”ÐµÑ‚ÑÐºÐ¸Ðµ ÐºÐ½Ð¸Ð³Ð¸' LIMIT 1)
);
```

#### Ð¨Ð°Ð³ 3: Ð¡Ð²ÑÐ·Ñ‹Ð²Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð¸ Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ð¼Ð¸
```sql
INSERT INTO public.book_authors (book_id, author_id)
VALUES (
  (SELECT id FROM public.books WHERE title = 'ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ ÐºÐ½Ð¸Ð³Ð¸' LIMIT 1),
  (SELECT id FROM public.authors WHERE name = 'Ð˜Ð¼Ñ ÐÐ²Ñ‚Ð¾Ñ€Ð°' LIMIT 1)
);
```

### 2. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸

#### Ð¨Ð°Ð³ 1: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð»Ð°Ð½Ð° (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)
```sql
INSERT INTO public.plans (name, description, price_monthly, max_books_per_month, max_books_total)
VALUES (
  'Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¿Ð»Ð°Ð½',
  'Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº 5 ÐºÐ½Ð¸Ð³Ð°Ð¼ Ð² Ð¼ÐµÑÑÑ†',
  100.00,
  5,
  50
);
```

#### Ð¨Ð°Ð³ 2: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸
```sql
SELECT public.create_subscription(
  'user-uuid-here',
  (SELECT id FROM public.plans WHERE name = 'Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¿Ð»Ð°Ð½' LIMIT 1),
  1
);
```

### 3. ÐŸÐ¾Ð¸ÑÐº ÐºÐ½Ð¸Ð³

#### ÐŸÐ¾ Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ
```sql
SELECT * FROM public.search_books_by_author('ÐŸÑƒÑˆÐºÐ¸Ð½', 10);
```

#### ÐŸÐ¾ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
```sql
SELECT b.*, a.name as author_name
FROM public.books b
LEFT JOIN public.book_authors ba ON ba.book_id = b.id
LEFT JOIN public.authors a ON a.id = ba.author_id
LEFT JOIN public.main_categories c ON c.id = b.subcategory_id
WHERE c.name ILIKE '%Ð´ÐµÑ‚ÑÐº%'
LIMIT 20;
```

#### ÐŸÐ¾Ð»Ð½Ð¾Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð¸ÑÐº
```sql
SELECT * FROM public.books
WHERE tsvector @@ plainto_tsquery('ukrainian', 'ÑÐºÐ°Ð·ÐºÐ¸')
ORDER BY ts_rank(tsvector, plainto_tsquery('ukrainian', 'ÑÐºÐ°Ð·ÐºÐ¸')) DESC;
```

---

## âœ… Ð§ÐµÐº-Ð»Ð¸ÑÑ‚Ñ‹

### Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ°

#### ÐŸÐµÑ€ÐµÐ´ Ð½Ð°Ñ‡Ð°Ð»Ð¾Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Supabase
- [ ] Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ð¼
- [ ] Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ (ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾)

#### ÐŸÑ€Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð½Ð¾Ð²Ð¾Ð¹ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸
- [ ] Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑŽ Ð´Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ ÑÑ…ÐµÐ¼Ñ‹
- [ ] Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð»Ñ Ð½Ð¾Ð²Ñ‹Ñ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†
- [ ] ÐÐ°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ñ `SET search_path = public`
- [ ] ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ

#### ÐŸÑ€Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒÑÐºÐ¸Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸ÑŽ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
- [ ] Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ð² ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚Ð¸ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸Ðº
- [ ] Ð’Ð°Ð»Ð¸Ð´Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
- [ ] Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð²Ð°Ð¶Ð½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸

### Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°

#### Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº
- [ ] ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð² Ð»Ð¾Ð³Ð°Ñ…
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ

#### Ð•Ð¶ÐµÐ½ÐµÐ´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ†ÐµÐ»Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
- [ ] ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¸Ð½Ð´ÐµÐºÑÑ‹
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ

#### Ð•Ð¶ÐµÐ¼ÐµÑÑÑ‡Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ñ‡Ð¸
- [ ] Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ
- [ ] ÐÐ½Ð°Ð»Ð¸Ð· Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²Ð¸Ñ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸ÑÐ¼

### Ð§ÐµÐº-Ð»Ð¸ÑÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸

#### Ð ÐµÐ³ÑƒÐ»ÑÑ€Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
- [ ] Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ð² Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ð¸ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²

#### ÐŸÑ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ…
- [ ] ÐŸÑ€Ð¾Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
- [ ] ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ Ð½Ð° Ð¿Ð¾Ð´Ð¾Ð·Ñ€Ð¸Ñ‚ÐµÐ»ÑŒÐ½ÑƒÑŽ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ
- [ ] Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ Ð² ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¹
- [ ] ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Security Advisor

---

## ðŸ”§ Troubleshooting

### Ð§Ð°ÑÑ‚Ñ‹Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹

#### 1. ÐžÑˆÐ¸Ð±ÐºÐ° "permission denied"
**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°**: RLS Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿
**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**: 
```sql
-- ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ð¸Ñ‚Ð¸ÐºÐ¸
SELECT * FROM pg_policies WHERE tablename = 'table_name';

-- Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ RLS Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
ALTER TABLE public.table_name DISABLE ROW LEVEL SECURITY;
```

#### 2. ÐžÑˆÐ¸Ð±ÐºÐ° "function search_path mutable"
**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°**: Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ `SET search_path`
**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**:
```sql
-- Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ search_path Ðº Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
CREATE OR REPLACE FUNCTION function_name()
RETURNS type
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
-- ÐºÐ¾Ð´ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
$$;
```

#### 3. ÐœÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹
**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°**: ÐžÑ‚ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²
**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**:
```sql
-- Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¸Ð½Ð´ÐµÐºÑ
CREATE INDEX idx_books_title ON public.books USING gin(to_tsvector('ukrainian', title));

-- ÐÐ½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ
EXPLAIN ANALYZE SELECT * FROM public.books WHERE title ILIKE '%Ð¿Ð¾Ð¸ÑÐº%';
```

#### 4. ÐŸÑ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ñ Cloudinary
**ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð°**: ÐÐµÐ¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ URL Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
**Ð ÐµÑˆÐµÐ½Ð¸Ðµ**:
```sql
-- ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ URL Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ð¹
UPDATE public.books 
SET cover_url = REPLACE(cover_url, 'old-domain', 'new-domain')
WHERE cover_url LIKE '%old-domain%';
```

### ÐœÐ¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸

#### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¼ÐµÐ´Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð²
```sql
SELECT 
  query,
  calls,
  total_time,
  mean_time,
  rows
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
```

#### ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸Ð½Ð´ÐµÐºÑÐ¾Ð²
```sql
SELECT 
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read,
  idx_tup_fetch
FROM pg_stat_user_indexes
ORDER BY idx_scan DESC;
```

---

## ðŸ“š Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ€ÐµÑÑƒÑ€ÑÑ‹

### ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹

#### Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾ ÐºÐ½Ð¸Ð³Ð°Ð¼
```sql
SELECT 
  COUNT(*) as total_books,
  COUNT(CASE WHEN subcategory_id IS NOT NULL THEN 1 END) as categorized_books,
  AVG(pages) as avg_pages
FROM public.books;
```

#### Ð¢Ð¾Ð¿ Ð°Ð²Ñ‚Ð¾Ñ€Ð¾Ð²
```sql
SELECT 
  a.name,
  COUNT(ba.book_id) as books_count
FROM public.authors a
LEFT JOIN public.book_authors ba ON ba.author_id = a.id
GROUP BY a.id, a.name
ORDER BY books_count DESC
LIMIT 10;
```

#### Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¾Ðº
```sql
SELECT 
  p.name as plan_name,
  COUNT(s.id) as subscriptions_count,
  AVG(s.total_books_used) as avg_books_used
FROM public.plans p
LEFT JOIN public.subscriptions s ON s.plan_id = p.id
GROUP BY p.id, p.name
ORDER BY subscriptions_count DESC;
```

### ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹ Ð¸ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ°

- **Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Supabase**: https://supabase.com/docs
- **PostgreSQL Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ**: https://www.postgresql.org/docs/
- **Cloudinary Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ**: https://cloudinary.com/documentation

---

**Ð’ÐµÑ€ÑÐ¸Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ð¸**: 1.0  
**Ð”Ð°Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ**: 10 ÑÐµÐ½Ñ‚ÑÐ±Ñ€Ñ 2025  
**ÐÐ²Ñ‚Ð¾Ñ€**: Stefa.Books Development Team
