# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é —Å–∏—Å—Ç–µ–º—ã –ø–æ–¥–ø–∏—Å–∫–∏

## üß™ –ë—ã—Å—Ç—Ä–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
npm run dev

# –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
http://localhost:3000/subscribe
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã –ø–æ–¥–ø–∏—Å–∫–∏

1. **–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:**
   - –ò–º—è: `–¢–µ—Å—Ç –¢–µ—Å—Ç–æ–≤–∏—á`
   - Email: `test@example.com`
   - –¢–µ–ª–µ—Ñ–æ–Ω: `+380123456789`
   - –ü–ª–∞–Ω: `Mini` (300 ‚Ç¥)
   - –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: `–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞`

2. **–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ä–º—É** - –≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É Monobank

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoints

```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
curl -X POST http://localhost:3000/api/payments/monobank \
  -H "Content-Type: application/json" \
  -d '{
    "amount": 300,
    "description": "Test payment",
    "customer_email": "test@example.com"
  }'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ invoice_id –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π)
curl "http://localhost:3000/api/payments/monobank?invoice_id=test_invoice"
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

–í Supabase SQL Editor –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É
SELECT * FROM subscription_requests 
ORDER BY created_at DESC 
LIMIT 5;

-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–æ–¥–ø–∏—Å–∫–∞–º–∏
SELECT id, name, email, subscription_type, subscription_start, subscription_end, status 
FROM users 
WHERE subscription_type IS NOT NULL
ORDER BY created_at DESC 
LIMIT 5;
```

## üîç –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

### ‚úÖ –£—Å–ø–µ—à–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. **–§–æ—Ä–º–∞ –ø–æ–¥–ø–∏—Å–∫–∏:**
   - [ ] –§–æ—Ä–º–∞ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - [ ] –ü—Ä–∏ –≤—ã–±–æ—Ä–µ "–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞" –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
   - [ ] –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ Monobank

2. **API —Å–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞:**
   - [ ] –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `success: true`
   - [ ] –°–æ–¥–µ—Ä–∂–∏—Ç `paymentUrl` –∏ `invoiceId`
   - [ ] –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏

3. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:**
   - [ ] –ó–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `subscription_requests`
   - [ ] –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏: `pending`
   - [ ] –ü–ª–∞—Ç–µ–∂ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ Monobank

### ‚ùå –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**
   - [ ] –ù–µ–≤–µ—Ä–Ω—ã–π email —Ñ–æ—Ä–º–∞—Ç
   - [ ] –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
   - [ ] –ù–µ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

2. **API –æ—à–∏–±–∫–∏:**
   - [ ] –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç `MONOBANK_TOKEN`
   - [ ] –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø—Ä–æ—Å–∞
   - [ ] –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞

```javascript
// –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console
// –ò—â–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º:
// - "SubscriptionService:"
// - "MonobankPaymentService:"
// - "Payment creation"
```

### –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω npm run dev
# –ò—â–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è:
# - "Creating Monobank payment"
# - "Payment created successfully"
# - "Subscription activated successfully"
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env.local
cat .env.local

# –î–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å:
# MONOBANK_TOKEN=uSjulrJT5jqGnzy8lSQoasq04GRtKMo0myvxJk5D0EKY
# NEXT_PUBLIC_SITE_URL=http://localhost:3000
```

## üö® –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. "Monobank token not configured"

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `MONOBANK_TOKEN` –≤ `.env.local`

### 2. "Failed to create payment"

**–†–µ—à–µ–Ω–∏–µ:** 
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω Monobank
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ API Monobank –¥–æ—Å—Ç—É–ø–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

### 3. "Database error"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã `users` –∏ `subscription_requests` —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ RLS –ø–æ–ª–∏—Ç–∏–∫–∏

### 4. "Webhook not received"

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL webhook –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Monobank
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ ngrok –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏

1. **–£—Å–ø–µ—à–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏:**
   ```sql
   SELECT COUNT(*) as successful_payments
   FROM subscription_requests 
   WHERE status = 'completed';
   ```

2. **–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏:**
   ```sql
   SELECT COUNT(*) as active_subscriptions
   FROM users 
   WHERE status = 'active' 
   AND subscription_end > NOW();
   ```

3. **–û—à–∏–±–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:**
   ```sql
   SELECT COUNT(*) as failed_payments
   FROM subscription_requests 
   WHERE status = 'rejected';
   ```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Netlify

```
MONOBANK_TOKEN=uSjulrJT5jqGnzy8lSQoasq04GRtKMo0myvxJk5D0EKY
NEXT_PUBLIC_SITE_URL=https://stefa-books.com.ua
```

### 2. Webhook –≤ Monobank

- URL: `https://stefa-books.com.ua/api/payments/monobank/webhook`
- –°–æ–±—ã—Ç–∏—è: `invoice.status.changed`

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

1. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–¥–ø–∏—Å–∫—É
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—ã –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ Monobank
3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—É—é –æ–ø–ª–∞—Ç—É
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏** –≤ Netlify Dashboard ‚Üí Functions ‚Üí Logs
2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö** –≤ Supabase Dashboard
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** Monobank –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ
4. **–°–æ–∑–¥–∞–π—Ç–µ issue** —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã –∏ –ª–æ–≥–∞–º–∏

---

**–ì–æ—Ç–æ–≤–æ!** üéâ –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –ø–æ–¥–ø–∏—Å–∫–∏ —Å Monobank.
