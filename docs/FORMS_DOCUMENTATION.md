# Forms Documentation - Stefa.Books

## Обзор

Этот документ описывает все формы в проекте Stefa.Books, их функциональность, валидацию и интеграцию с API.

## Содержание

1. [Рабочие формы](#рабочие-формы)
   - [Форма подписки (SubscribeModal)](#форма-подписки-subscribemodal)
   - [Форма аренды книги (BookRentalForm)](#форма-аренды-книги-bookrentalform)
   - [Форма добавления книги (NewBookPage)](#форма-добавления-книги-newbookpage)
2. [Mock-формы](#mock-формы)
   - [Общая форма аренды (RentalForm)](#общая-форма-аренды-rentalform)
   - [Форма оформления заказа (CheckoutPage)](#форма-оформления-заказа-checkoutpage)
3. [Валидация форм](#валидация-форм)
4. [Рекомендации по улучшению](#рекомендации-по-улучшению)

---

## Рабочие формы

### Форма подписки (SubscribeModal)

**Расположение:** `src/components/SubscribeModal.tsx`  
**API endpoint:** `POST /api/subscribe`  
**Статус:** ✅ Полностью работает

#### Описание
Модальное окно для оформления подписки на сервис аренды книг.

#### Поля формы

| Поле | Тип | Обязательное | Валидация |
|------|-----|--------------|-----------|
| name | string | ✓ | Мин. 2 символа |
| email | string | ✓ | Валидный email |
| phone | string | ✓ | Формат +380XXXXXXXXX |
| social | string | ✗ | @username или username |
| plan | enum | ✓ | 'mini' или 'maxi' |
| paymentMethod | enum | ✓ | 'Онлайн оплата' или 'Переказ на карту' |
| message | string | ✗ | Макс. 500 символов |
| screenshot | file | ✗* | Только для 'Переказ на карту' |
| privacyConsent | boolean | ✓ | Должно быть true |

#### Особенности реализации

1. **Динамическая валидация**: Поле `screenshot` становится обязательным при выборе "Переказ на карту"
2. **Автоформатирование телефона**: Автоматически добавляет префикс +380
3. **Интеграция с Monobank**: При выборе "Онлайн оплата" создается платеж через Monobank API
4. **Загрузка файлов**: Скриншоты загружаются в Cloudinary

#### Пример использования
```tsx
import SubscribeModal from '@/components/SubscribeModal'

<SubscribeModal isOpen={true} onClose={() => setIsOpen(false)} />
```

### Форма аренды книги (BookRentalForm)

**Расположение:** `src/components/rental/BookRentalForm.tsx`  
**API endpoint:** `POST /api/rent`  
**Статус:** ✅ Полностью работает

#### Описание
Форма для оформления аренды конкретной книги с выбором плана и способа доставки.

#### Поля формы

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| plan | enum | ✓ | 'basic', 'extended', 'premium' |
| deliveryMethod | enum | ✓ | 'pickup', 'kyiv', 'ukraine' |
| firstName | string | ✓ | Имя клиента |
| lastName | string | ✓ | Фамилия клиента |
| email | string | ✓ | Email для связи |
| phone | string | ✓ | Телефон |
| address | string | ✗ | Адрес доставки |
| city | string | ✗ | Город |
| postalCode | string | ✗ | Почтовый индекс |
| notes | string | ✗ | Дополнительные заметки |
| paymentMethod | enum | ✓ | 'card', 'cash', 'bank' |

#### Особенности реализации

1. **Расчет стоимости**: Автоматический расчет на основе плана и доставки
2. **Проверка авторизации**: Перенаправление на логин для неавторизованных
3. **Предзаполнение данных**: Использует данные из профиля пользователя
4. **Подтверждение**: После успешной аренды перенаправляет на страницу подтверждения

### Форма добавления книги (NewBookPage)

**Расположение:** `src/app/books/new/page.tsx`  
**API endpoint:** `POST /api/admin/books`  
**Статус:** ✅ Полностью работает (обновлена)

#### Описание
Административная форма для добавления новых книг в каталог.

#### Поля формы

| Поле | Тип | Обязательное | Описание |
|------|-----|--------------|----------|
| title | string | ✓ | Название книги |
| author | string | ✓ | Автор |
| isbn | string | ✗ | ISBN код |
| publishedDate | date | ✗ | Дата публикации |
| publisher | string | ✗ | Издательство |
| category | string | ✗ | Категория |
| description | string | ✗ | Описание |
| coverImage | string | ✗ | URL обложки |
| price | number | ✗ | Цена аренды |

#### Особенности реализации

1. **Валидация на сервере**: Использует Zod для валидации
2. **Очистка формы**: После успешного создания форма очищается
3. **Обработка ошибок**: Показывает детальные сообщения об ошибках

---

## Mock-формы

### Общая форма аренды (RentalForm)

**Расположение:** `src/components/RentalForm.tsx`  
**Статус:** ⚠️ Не используется в приложении

#### Описание
Альтернативная форма аренды с другой структурой данных. Не интегрирована с текущим API.

#### Почему не используется
- Использует устаревшую структуру данных
- Основная форма аренды (`BookRentalForm`) полностью покрывает функциональность
- Требует отдельного API endpoint для работы

### Форма оформления заказа (CheckoutPage)

**Расположение:** `src/app/rent/checkout/page.tsx`  
**Статус:** ⚠️ Mock-страница

#### Описание
Демонстрационная страница процесса оплаты. Не отправляет данные на сервер.

#### Особенности
- Использует mock-данные для книги
- Имитирует процесс оплаты
- Перенаправляет на страницу подтверждения без создания реального заказа

---

## Валидация форм

### Клиентская валидация

Все формы используют комбинацию:
- React Hook Form для управления состоянием
- Zod для схем валидации
- Кастомные валидаторы для специфичных полей

### Серверная валидация

API endpoints используют:
- Zod для валидации входящих данных
- Детальные сообщения об ошибках
- Статус коды 400 для ошибок валидации

### Пример схемы валидации
```typescript
const subscribeFormSchema = z.object({
  name: z.string().min(2, 'Ім\'я занадто коротке'),
  email: z.string().email('Невірний формат email'),
  phone: z.string().regex(/^\+380\d{9}$/, 'Невірний формат телефону'),
  social: z.string().optional(),
  plan: z.enum(['mini', 'maxi']),
  paymentMethod: z.enum(['Онлайн оплата', 'Переказ на карту']),
  message: z.string().max(500).optional(),
  privacyConsent: z.literal(true, {
    errorMap: () => ({ message: 'Необхідно погодитись з умовами' })
  })
})
```

---

## Рекомендации по улучшению

### 1. Интеграция RentalForm
Если требуется общая форма аренды:
- Обновить структуру данных под текущий API
- Или создать отдельный endpoint для этой формы

### 2. Реализация CheckoutPage
Для полноценной страницы оплаты:
- Создать API endpoint для обработки платежей
- Интегрировать с платежной системой
- Добавить сохранение заказов в БД

### 3. Улучшение UX
- Добавить индикаторы загрузки во все формы
- Реализовать автосохранение черновиков
- Добавить превью загружаемых изображений

### 4. Безопасность
- Добавить CSRF защиту
- Реализовать rate limiting для форм
- Добавить капчу для публичных форм

### 5. Мониторинг
- Логирование всех отправок форм
- Отслеживание ошибок валидации
- Аналитика конверсии форм

---

## Тестирование форм

### Автоматические тесты
```typescript
// Пример теста для формы подписки
describe('SubscribeModal', () => {
  it('should validate required fields', async () => {
    render(<SubscribeModal isOpen={true} onClose={() => {}} />)
    
    const submitButton = screen.getByText('Надіслати заявку')
    fireEvent.click(submitButton)
    
    expect(screen.getByText('Ім\'я обов\'язкове')).toBeInTheDocument()
    expect(screen.getByText('Email обов\'язковий')).toBeInTheDocument()
  })
})
```

### Ручное тестирование
1. Проверка валидации всех полей
2. Тест отправки с корректными данными
3. Проверка обработки ошибок сервера
4. Тест на разных устройствах
5. Проверка доступности (a11y)

---

*Последнее обновление: 11 сентября 2025*
