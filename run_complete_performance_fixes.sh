#!/bin/bash

# =====================================================
# –ü–û–õ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò
# =====================================================
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –í–°–ï –ø—Ä–æ–±–ª–µ–º—ã –∏–∑ Performance Advisor:
# 1. –ù–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
# 2. RLS –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ Stefa.Books..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${BLUE}[$(date +'%H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

error() {
    echo -e "${RED}‚ùå $1${NC}"
}

warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ -z "$SUPABASE_URL" ]; then
    error "–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SUPABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞"
    echo "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ—ë –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "export SUPABASE_URL='your_supabase_database_url'"
    echo ""
    echo "–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env.local —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º:"
    echo "SUPABASE_URL=your_supabase_database_url"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ psql
if ! command -v psql &> /dev/null; then
    error "psql –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ PostgreSQL client"
    exit 1
fi

# =====================================================
# –≠–¢–ê–ü 1: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ò–ù–î–ï–ö–°–û–í
# =====================================================

log "–≠—Ç–∞–ø 1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π..."

if psql "$SUPABASE_URL" -f "PERFORMANCE_FIXES_SAFE.sql"; then
    success "–ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ"
else
    error "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤"
    exit 1
fi

# =====================================================
# –≠–¢–ê–ü 2: –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï RLS –ü–†–û–ë–õ–ï–ú
# =====================================================

log "–≠—Ç–∞–ø 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."

if psql "$SUPABASE_URL" -f "FIX_RLS_PERFORMANCE_SAFE.sql"; then
    success "RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã"
else
    error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ RLS –ø–æ–ª–∏—Ç–∏–∫"
    exit 1
fi

# =====================================================
# –≠–¢–ê–ü 3: –û–ß–ò–°–¢–ö–ê –ò –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø
# =====================================================

log "–≠—Ç–∞–ø 3: –û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

if psql "$SUPABASE_URL" -c "VACUUM ANALYZE;"; then
    success "–û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∞"
else
    warning "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)"
fi

# =====================================================
# –≠–¢–ê–ü 4: –ü–†–û–í–ï–†–ö–ê –†–ï–ó–£–õ–¨–¢–ê–¢–û–í
# =====================================================

log "–≠—Ç–∞–ø 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤..."

# –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
REPORT_FILE="complete_performance_fix_report_$(date +%Y%m%d_%H%M%S).md"

cat > "$REPORT_FILE" << EOF
# –û–¢–ß–ï–¢ –û –ü–û–õ–ù–û–ú –ò–°–ü–†–ê–í–õ–ï–ù–ò–ò –ü–†–û–ò–ó–í–û–î–ò–¢–ï–õ–¨–ù–û–°–¢–ò

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** $(date)
**–ü—Ä–æ–µ–∫—Ç:** Stefa.Books
**–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö:** Supabase PostgreSQL

## –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ù–µ–∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏
- ‚úÖ books.subcategory_id ‚Üí main_categories.id
- ‚úÖ notification_queue.user_id ‚Üí users.id
- ‚úÖ book_authors.book_id ‚Üí books.id
- ‚úÖ book_authors.author_id ‚Üí authors.id
- ‚úÖ subcategories.main_category_id ‚Üí main_categories.id
- ‚úÖ subscriptions.user_id ‚Üí users.id
- ‚úÖ subscriptions.plan_id ‚Üí plans.id
- ‚úÖ payments.user_id ‚Üí users.id
- ‚úÖ reading_history.user_id ‚Üí users.id
- ‚úÖ reading_history.book_id ‚Üí books.id

### 2. RLS –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è payments
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è notification_queue
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è reading_history
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è users
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è subscriptions
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü

### 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–∞–º
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

EOF

# –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤
log "–°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤..."
psql "$SUPABASE_URL" -c "
SELECT 
    '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤' as section,
    COUNT(*) as total_indexes,
    SUM(CASE WHEN idx_scan > 0 THEN 1 ELSE 0 END) as used_indexes,
    SUM(CASE WHEN idx_scan = 0 THEN 1 ELSE 0 END) as unused_indexes
FROM pg_stat_user_indexes 
WHERE schemaname = 'public'
    AND indexrelname LIKE 'idx_%';
" >> "$REPORT_FILE" 2>/dev/null || warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–Ω–¥–µ–∫—Å–æ–≤"

# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö
log "–°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö..."
psql "$SUPABASE_URL" -c "
SELECT 
    'RLS –ø–æ–ª–∏—Ç–∏–∫–∏' as section,
    COUNT(*) as total_policies,
    COUNT(CASE WHEN qual LIKE '%SELECT auth.uid()%' THEN 1 END) as optimized_policies
FROM pg_policies 
WHERE schemaname = 'public';
" >> "$REPORT_FILE" 2>/dev/null || warning "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö"

success "–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω: $REPORT_FILE"

# =====================================================
# –ó–ê–í–ï–†–®–ï–ù–ò–ï
# =====================================================

echo ""
echo "üéâ –ü–æ–ª–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:"
echo "   ‚Ä¢ –°–æ–∑–¥–∞–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –≤—Å–µ—Ö –≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π"
echo "   ‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
echo "   ‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
echo "   ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Performance Advisor –≤ Supabase"
echo "   2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π —É–º–µ–Ω—å—à–∏–ª–æ—Å—å"
echo "   3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤"
echo "   4. –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É (ANALYZE)"
echo ""
echo "üìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç: $REPORT_FILE"
echo ""

success "–í—Å–µ –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã! üöÄ"