#!/bin/bash

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–ª–æ—è - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–≥–¥–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞
echo "üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–µ–ø–ª–æ—è –≤–µ—Ä—Å–∏–∏ 20250919-1841..."
echo "‚è∞ –ù–∞—á–∞–ª–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: $(date)"
echo ""

EXPECTED_BUILD_ID="20250919-1841"
SITE_URL="https://stefa-books.com.ua"
CHECK_INTERVAL=30 # —Å–µ–∫—É–Ω–¥
MAX_CHECKS=20     # –º–∞–∫—Å–∏–º—É–º 10 –º–∏–Ω—É—Ç

for i in $(seq 1 $MAX_CHECKS); do
    echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ #$i ($(date +%H:%M:%S))..."

    # –ü–æ–ª—É—á–∞–µ–º BUILD_ID —Å —Å–∞–π—Ç–∞
    CURRENT_BUILD_ID=$(curl -s -I "$SITE_URL" | grep -i "x-build-id" | cut -d' ' -f2 | tr -d '\r\n')

    echo "   –¢–µ–∫—É—â–∞—è –≤–µ—Ä—Å–∏—è: $CURRENT_BUILD_ID"
    echo "   –û–∂–∏–¥–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è: $EXPECTED_BUILD_ID"

    if [[ "$CURRENT_BUILD_ID" == "$EXPECTED_BUILD_ID" ]]; then
        echo ""
        echo "üéâ –£–°–ü–ï–•! –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞!"
        echo "‚úÖ –í–µ—Ä—Å–∏—è $EXPECTED_BUILD_ID —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ $SITE_URL"
        echo "‚è∞ –í—Ä–µ–º—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è: $(date)"
        echo ""
        echo "üîÑ –¢–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç:"
        echo "   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ favicon"
        echo "   - –†–∞–±–æ—Ç–∞—é—â–∏–µ book preview modals"
        echo "   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö"
        echo ""

        # –ü—Ä–æ–≤–µ—Ä–∏–º –≤–µ—Ä—Å–∏—é Service Worker
        echo "üõ†Ô∏è  –ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker..."
        curl -s "$SITE_URL/sw.js" | head -2

        exit 0
    fi

    if [ $i -lt $MAX_CHECKS ]; then
        echo "   ‚è≥ –ñ–¥–µ–º $CHECK_INTERVAL —Å–µ–∫—É–Ω–¥ –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏..."
        echo ""
        sleep $CHECK_INTERVAL
    fi
done

echo ""
echo "‚ö†Ô∏è  –î–µ–ø–ª–æ–π –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å"
echo "üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
echo "   - Netlify –±–∏–ª–¥ –µ—â–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è"
echo "   - DNS –∫–µ—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –º–µ–¥–ª–µ–Ω–Ω–µ–µ"
echo "   - CDN –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ"
echo ""
echo "üîó –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –Ω–∞ https://app.netlify.com/projects/stefabooks"