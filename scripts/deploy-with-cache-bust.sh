#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—è —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π –∫–µ—à–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
# –ê–≤—Ç–æ—Ä: Claude Code Assistant

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π –∫–µ—à–∞..."

# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π BUILD_ID –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
NEW_BUILD_ID=$(date +"%Y%m%d-%H%M")
echo "üìÖ –ù–æ–≤—ã–π BUILD_ID: $NEW_BUILD_ID"

# –û–±–Ω–æ–≤–ª—è–µ–º BUILD_ID –≤ next.config.js
echo "üîß –û–±–Ω–æ–≤–ª—è–µ–º BUILD_ID –≤ next.config.js..."
sed -i.bak "s/const BUILD_ID = '[^']*'/const BUILD_ID = '$NEW_BUILD_ID'/" next.config.js

# –û–±–Ω–æ–≤–ª—è–µ–º BUILD_ID –≤ Service Worker
echo "üîß –û–±–Ω–æ–≤–ª—è–µ–º BUILD_ID –≤ Service Worker..."
sed -i.bak "s/stefa-books-cache-[^']*'/stefa-books-cache-$NEW_BUILD_ID'/" public/sw.js
sed -i.bak "s/const BUILD_ID = '[^']*'/const BUILD_ID = '$NEW_BUILD_ID'/" public/sw.js

# –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
echo "$NEW_BUILD_ID" > public/version.txt
echo "üìù –í–µ—Ä—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ public/version.txt"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å git
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ git..."
if [[ -n $(git status --porcelain) ]]; then
    echo "üì¶ –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è..."
    git add .
    git commit -m "üîÑ Auto-deploy: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–µ—à–∞ –∏ –≤–µ—Ä—Å–∏–∏ –¥–æ $NEW_BUILD_ID

üîß Automated deployment with cache busting for users.

Co-Authored-By: Claude <noreply@anthropic.com>"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–µ—Ç–∫–µ
CURRENT_BRANCH=$(git branch --show-current)
echo "üåø –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

if [[ "$CURRENT_BRANCH" != "main" ]]; then
    echo "‚ö†Ô∏è  –í—ã –Ω–µ –Ω–∞ –≤–µ—Ç–∫–µ main. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è..."
    git checkout main
fi

# –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
echo "üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ GitHub..."
git push origin main

# –î–µ–ø–ª–æ–∏–º –Ω–∞ Netlify
echo "üåê –î–µ–ø–ª–æ–∏–º –Ω–∞ Netlify..."
netlify deploy --prod

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è
echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üîó –°–∞–π—Ç: https://stefa-books.com.ua"
echo "üìã –í–µ—Ä—Å–∏—è: $NEW_BUILD_ID"

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
echo ""
echo "üéØ –í–ê–ñ–ù–û –î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô:"
echo "   - Service Worker –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–¥–æ–º–∏—Ç –æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏"
echo "   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏"
echo "   - –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ '–û–±–Ω–æ–≤–∏—Ç—å' –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–µ—à–µ–π"
echo ""

# DNS –∫–µ—à information
echo "üåê –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û DNS:"
echo "   - DNS –∫–µ—à –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 1-5 –º–∏–Ω—É—Ç"
echo "   - –î–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ DNS: netlify domains:list"
echo "   - TTL –¥–ª—è –¥–æ–º–µ–Ω–∞ –æ–±—ã—á–Ω–æ 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)"
echo ""

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üßπ –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
rm -f next.config.js.bak public/sw.js.bak 2>/dev/null || true

echo "‚ú® –î–µ–ø–ª–æ–π —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π –∫–µ—à–∞ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üîÑ –ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è $NEW_BUILD_ID –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"