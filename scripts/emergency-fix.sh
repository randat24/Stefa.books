#!/bin/bash

# üö® –ê–í–ê–†–ò–ô–ù–´–ô –°–ö–†–ò–ü–¢ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö!

set -e

echo "üö® –ê–í–ê–†–ò–ô–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´"
echo "=================================="

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
log() {
    echo -e "${GREEN}[$(date +'%Y-%m-%d %H:%M:%S')] $1${NC}"
}

error() {
    echo -e "${RED}[ERROR] $1${NC}"
}

warning() {
    echo -e "${YELLOW}[WARNING] $1${NC}"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥
check_commands() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–º–∞–Ω–¥..."
    
    if ! command -v pnpm &> /dev/null; then
        error "pnpm –Ω–µ –Ω–∞–π–¥–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pnpm: npm install -g pnpm"
        exit 1
    fi
    
    if ! command -v git &> /dev/null; then
        error "git –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi
    
    if ! command -v netlify &> /dev/null; then
        warning "netlify CLI –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: npm install -g netlify-cli"
    fi
    
    log "–í—Å–µ –∫–æ–º–∞–Ω–¥—ã –Ω–∞–π–¥–µ–Ω—ã ‚úÖ"
}

# –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
clean_cache() {
    log "–û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
    
    # –û—á–∏—Å—Ç–∫–∞ Next.js –∫–µ—à–∞
    rm -rf .next
    rm -rf out
    rm -rf dist
    rm -rf coverage
    rm -rf performance-reports
    
    # –û—á–∏—Å—Ç–∫–∞ node_modules –∫–µ—à–∞
    rm -rf node_modules/.cache
    
    # –û—á–∏—Å—Ç–∫–∞ pnpm –∫–µ—à–∞
    pnpm store prune
    
    log "–ö–µ—à –æ—á–∏—â–µ–Ω ‚úÖ"
}

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
restore_dependencies() {
    log "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    # –£–¥–∞–ª–µ–Ω–∏–µ lock —Ñ–∞–π–ª–æ–≤
    rm -f package-lock.json
    rm -f yarn.lock
    
    # –£–¥–∞–ª–µ–Ω–∏–µ node_modules
    rm -rf node_modules
    
    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    pnpm install
    
    log "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã ‚úÖ"
}

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TypeScript –æ—à–∏–±–æ–∫
fix_typescript() {
    log "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TypeScript –æ—à–∏–±–æ–∫..."
    
    # –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∏–ø–æ–≤
    if [ -f "scripts/fix-typescript-errors.sh" ]; then
        chmod +x scripts/fix-typescript-errors.sh
        ./scripts/fix-typescript-errors.sh
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
    pnpm run type-check || warning "TypeScript –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–ª–∏—Å—å, –Ω–æ —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è"
    
    log "TypeScript –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ"
}

# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESLint –æ—à–∏–±–æ–∫
fix_eslint() {
    log "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESLint –æ—à–∏–±–æ–∫..."
    
    # –ê–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ ESLint
    pnpm run lint:fix || warning "ESLint –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–ª–∏—Å—å"
    
    log "ESLint –∏—Å–ø—Ä–∞–≤–ª–µ–Ω ‚úÖ"
}

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
restore_config() {
    log "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ next.config.js
    if [ ! -f "next.config.js" ]; then
        error "next.config.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ tsconfig.json
    if [ ! -f "tsconfig.json" ]; then
        error "tsconfig.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json
    if [ ! -f "package.json" ]; then
        error "package.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        exit 1
    fi
    
    log "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ ‚úÖ"
}

# –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞
test_build() {
    log "–¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞..."
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏
    if pnpm run build; then
        log "–°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞ ‚úÖ"
    else
        error "–°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å!"
        
        # –ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏ —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫
        warning "–ü–æ–ø—ã—Ç–∫–∞ —Å–±–æ—Ä–∫–∏ —Å –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—à–∏–±–æ–∫..."
        NODE_OPTIONS="--max-old-space-size=4096" pnpm run build || {
            error "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏!"
            exit 1
        }
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è
check_deployment() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫ –¥–µ–ø–ª–æ—é..."
    
    if [ -f "scripts/deployment-checklist.sh" ]; then
        chmod +x scripts/deployment-checklist.sh
        ./scripts/deployment-checklist.sh
    else
        warning "–°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–µ–ø–ª–æ—è –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
}

# –û—Ç–∫–∞—Ç –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ä–∞–±–æ—á–µ–º—É –∫–æ–º–º–∏—Ç—É
rollback() {
    log "–û—Ç–∫–∞—Ç –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ä–∞–±–æ—á–µ–º—É –∫–æ–º–º–∏—Ç—É..."
    
    # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
    LAST_WORKING=$(git log --oneline --grep="deploy" --grep="fix" --grep="build" | head -1 | cut -d' ' -f1)
    
    if [ -z "$LAST_WORKING" ]; then
        warning "–†–∞–±–æ—á–∏–π –∫–æ–º–º–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É"
        git reset --hard HEAD~1
    else
        log "–û—Ç–∫–∞—Ç –∫ –∫–æ–º–º–∏—Ç—É: $LAST_WORKING"
        git reset --hard $LAST_WORKING
    fi
    
    log "–û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ"
}

# –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
full_restore() {
    log "–ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
    
    # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    pkill -f "next dev" || true
    pkill -f "next start" || true
    
    # –û—á–∏—Å—Ç–∫–∞
    clean_cache
    restore_dependencies
    
    # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    restore_config
    
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
    fix_typescript
    fix_eslint
    
    # –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞
    test_build
    
    log "–ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ"
}

# –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
quick_fix() {
    log "–ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ..."
    
    # –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
    clean_cache
    
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
    fix_typescript
    fix_eslint
    
    # –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞
    test_build
    
    log "–ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚úÖ"
}

# –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–º–æ—â—å
show_help() {
    echo "üö® –ê–í–ê–†–ò–ô–ù–´–ô –°–ö–†–ò–ü–¢ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø"
    echo "=================================="
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–∫–æ–º–∞–Ω–¥–∞]"
    echo ""
    echo "–ö–æ–º–∞–Ω–¥—ã:"
    echo "  quick     - –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–æ—á–∏—Å—Ç–∫–∞ + –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫)"
    echo "  full      - –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ (–≤–∫–ª—é—á–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫—É –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π)"
    echo "  rollback  - –û—Ç–∫–∞—Ç –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Ä–∞–±–æ—á–µ–º—É –∫–æ–º–º–∏—Ç—É"
    echo "  clean     - –¢–æ–ª—å–∫–æ –æ—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞"
    echo "  test      - –¢–æ–ª—å–∫–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞"
    echo "  help      - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 quick      # –ë—ã—Å—Ç—Ä–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"
    echo "  $0 full       # –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ"
    echo "  $0 rollback   # –û—Ç–∫–∞—Ç –∫ —Ä–∞–±–æ—á–µ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é"
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    case "${1:-help}" in
        "quick")
            check_commands
            quick_fix
            ;;
        "full")
            check_commands
            full_restore
            ;;
        "rollback")
            check_commands
            rollback
            quick_fix
            ;;
        "clean")
            check_commands
            clean_cache
            ;;
        "test")
            check_commands
            test_build
            ;;
        "help"|*)
            show_help
            ;;
    esac
}

# –ó–∞–ø—É—Å–∫
main "$@"
