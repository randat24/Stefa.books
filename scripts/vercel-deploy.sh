#!/bin/bash

# üöÄ –°–∫—Ä–∏–ø—Ç –¥–ª—è –¥–µ–ø–ª–æ—é –Ω–∞ Vercel
# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è: ./scripts/vercel-deploy.sh [environment]

set -e

# –ö–æ–ª—å–æ—Ä–∏ –¥–ª—è –≤–∏–≤–æ–¥—É
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–≤–æ–¥—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç—ñ–≤
ENVIRONMENT=${1:-preview}

log "–ü–æ—á–∞—Ç–æ–∫ –¥–µ–ø–ª–æ—é –Ω–∞ Vercel (—Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: $ENVIRONMENT)"

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ Vercel CLI
if ! command -v vercel &> /dev/null; then
    error "Vercel CLI –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å: npm i -g vercel"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ pnpm
if ! command -v pnpm &> /dev/null; then
    error "pnpm –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å: npm i -g pnpm"
    exit 1
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å—É
log "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ Git —Å—Ç–∞—Ç—É—Å—É..."
if [ -n "$(git status --porcelain)" ]; then
    warning "–Ñ –Ω–µ–∑–±–µ—Ä–µ–∂–µ–Ω—ñ –∑–º—ñ–Ω–∏. –ó–±–µ—Ä–µ–∂—ñ—Ç—å —ó—Ö –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ—î–º."
    git status --short
    read -p "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        log "–î–µ–ø–ª–æ–π —Å–∫–∞—Å–æ–≤–∞–Ω–æ"
        exit 1
    fi
fi

# –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
log "–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π..."
pnpm install

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—ñ–≤ TypeScript
log "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—ñ–≤ TypeScript..."
pnpm type-check

# –õ—ñ–Ω—Ç—ñ–Ω–≥
log "–ó–∞–ø—É—Å–∫ –ª—ñ–Ω—Ç–µ—Ä–∞..."
pnpm lint

# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
log "–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç—ñ–≤..."
pnpm test

# –ë—ñ–ª–¥ –ø—Ä–æ–µ–∫—Ç—É
log "–ë—ñ–ª–¥ –ø—Ä–æ–µ–∫—Ç—É..."
pnpm build

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ .env —Ñ–∞–π–ª—ñ–≤
if [ ! -f ".env.local" ] && [ ! -f ".env.production" ]; then
    warning "–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ .env —Ñ–∞–π–ª—ñ–≤. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –≤ Vercel."
fi

# –î–µ–ø–ª–æ–π –Ω–∞ Vercel
log "–î–µ–ø–ª–æ–π –Ω–∞ Vercel..."

if [ "$ENVIRONMENT" = "production" ]; then
    log "–î–µ–ø–ª–æ–π –≤ production..."
    vercel --prod --yes
    success "–î–µ–ø–ª–æ–π –≤ production –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
else
    log "–î–µ–ø–ª–æ–π –≤ preview..."
    vercel --yes
    success "–î–µ–ø–ª–æ–π –≤ preview –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
fi

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –¥–µ–ø–ª–æ—é
log "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –¥–µ–ø–ª–æ—é..."
vercel ls

success "–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ! üéâ"

# –ü–æ–∫–∞–∑ –ø–æ—Å–∏–ª–∞–Ω—å
log "–ö–æ—Ä–∏—Å–Ω—ñ –∫–æ–º–∞–Ω–¥–∏:"
echo "  vercel ls                    - —Å–ø–∏—Å–æ–∫ –¥–µ–ø–ª–æ—ó–≤"
echo "  vercel logs                  - –ª–æ–≥–∏ –¥–µ–ø–ª–æ—é"
echo "  vercel inspect               - –¥–µ—Ç–∞–ª—ñ –¥–µ–ø–ª–æ—é"
echo "  vercel env ls                - –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞"
