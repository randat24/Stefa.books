#!/bin/bash

# ðŸš€ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Stefa.Books Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸

set -e

echo "ðŸš€ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Stefa.Books Ð´Ð»Ñ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸..."
echo ""

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
print_status() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Node.js
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Node.js..."
if ! command -v node &> /dev/null; then
    print_error "Node.js Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Node.js 18+ Ñ https://nodejs.org"
    exit 1
fi

NODE_VERSION=$(node --version | cut -d'v' -f2 | cut -d'.' -f1)
if [ "$NODE_VERSION" -lt 18 ]; then
    print_error "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Node.js 18+, Ñ‚ÐµÐºÑƒÑ‰Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ: $(node --version)"
    exit 1
fi
print_success "Node.js $(node --version) âœ“"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° pnpm
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° pnpm..."
if ! command -v pnpm &> /dev/null; then
    print_warning "pnpm Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼..."
    npm install -g pnpm
fi
print_success "pnpm $(pnpm --version) âœ“"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Git
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Git..."
if ! command -v git &> /dev/null; then
    print_error "Git Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Git Ñ https://git-scm.com"
    exit 1
fi
print_success "Git $(git --version) âœ“"

# ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° Ð²ÐµÑ‚ÐºÑƒ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸
print_status "ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° Ð²ÐµÑ‚ÐºÑƒ Lklhost..."
if git branch --list | grep -q "Lklhost"; then
    git checkout Lklhost
    print_success "ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð½Ð° Ð²ÐµÑ‚ÐºÑƒ Lklhost âœ“"
else
    print_warning "Ð’ÐµÑ‚ÐºÐ° Lklhost Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¾ÑÑ‚Ð°ÐµÐ¼ÑÑ Ð½Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ‚ÐºÐµ"
fi

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
print_status "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
pnpm install
print_success "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ âœ“"

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ°
print_status "ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ°..."
pnpm run clean:cache
print_success "ÐšÑÑˆ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½ âœ“"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env.local ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð°Ð¹Ð»Ð° .env.local..."
if [ ! -f ".env.local" ]; then
    print_warning "Ð¤Ð°Ð¹Ð» .env.local Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑˆÐ°Ð±Ð»Ð¾Ð½..."
    
    cat > .env.local << 'EOF'
# Supabase Configuration
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# Cloudinary Configuration
NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME=your_cloud_name
CLOUDINARY_API_KEY=your_api_key
CLOUDINARY_API_SECRET=your_api_secret

# Site Configuration
NEXT_PUBLIC_SITE_URL=http://localhost:3000

# Environment
NODE_ENV=development
EOF
    
    print_warning "Ð¡Ð¾Ð·Ð´Ð°Ð½ Ñ„Ð°Ð¹Ð» .env.local Ñ ÑˆÐ°Ð±Ð»Ð¾Ð½Ð¾Ð¼"
    print_warning "âš ï¸  Ð’ÐÐ–ÐÐž: Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð² .env.local"
else
    print_success "Ð¤Ð°Ð¹Ð» .env.local ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ âœ“"
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° TypeScript
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° TypeScript..."
pnpm run type-check
print_success "TypeScript Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð° âœ“"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ESLint
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ESLint..."
pnpm run lint
print_success "ESLint Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð° âœ“"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸
print_status "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸..."
pnpm run build
print_success "Ð¡Ð±Ð¾Ñ€ÐºÐ° ÑƒÑÐ¿ÐµÑˆÐ½Ð° âœ“"

echo ""
print_success "ðŸŽ‰ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!"
echo ""
print_status "Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:"
echo "1. Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ Ð² .env.local"
echo "2. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚: pnpm dev"
echo "3. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ http://localhost:3000 Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ"
echo ""
print_status "ÐŸÐ¾Ð»ÐµÐ·Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹:"
echo "â€¢ pnpm dev              - Ð—Ð°Ð¿ÑƒÑÐº dev ÑÐµÑ€Ð²ÐµÑ€Ð°"
echo "â€¢ pnpm build            - Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
echo "â€¢ pnpm test             - Ð—Ð°Ð¿ÑƒÑÐº Ñ‚ÐµÑÑ‚Ð¾Ð²"
echo "â€¢ pnpm lint:fix         - Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ESLint Ð¾ÑˆÐ¸Ð±Ð¾Ðº"
echo "â€¢ pnpm clean            - ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²"
echo ""
print_status "Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ:"
echo "â€¢ LOCAL_SETUP_GUIDE.md  - ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ð¾"
echo "â€¢ DATABASE_DOCUMENTATION.md - Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ Ð‘Ð”"
echo "â€¢ README.md             - ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸Ñ"
echo ""

# ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ°
read -p "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚ ÑÐµÐ¹Ñ‡Ð°Ñ? (y/n): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    print_status "Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°..."
    pnpm dev
fi
